{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      body { 
        padding-top: 70px;
      } 
    </style>
    <title>
      User Statistics
    </title>
    <link rel="shortcut icon" type="image/png" href="../static/images/favicon.png">

    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="User plots">
    <meta name="keywords" content="User QPS and Percentile latencies plots">

    <!-- Latest compiled and minified CSS -->
    <link href="../static/css/bootstrap.min.css" type="text/css" rel="stylesheet">
    <!-- Date Range picker CSS -->
    <link rel="stylesheet" type="text/css" href="../static/css/daterangepicker-bs3.css" />

    <!-- JQuery core javascript  -->
    <script type="text/javascript" src="../static/jQuery/jquery-1.11.3.min.js"></script>

    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="../static/js/bootstrap.min.js"></script>
    <!-- Moment Javascript -->
    <script type="text/javascript" src="../static/js/moment.min.js"></script>
    <!-- Google jsapi -->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <!-- Date Range picker Javascript -->
    <script type="text/javascript" src="../static/js/daterangepicker.js"></script>
  </head>

  <body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
          <div class="navbar-header">
            <button id="toggle_button" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>

          <div class="collapse navbar-collapse" id="navbar-collapse">
            <ul class="nav navbar-nav navbar-left">
              <li id="leaderboard_item" class=""><a href="/leaderboard">Performance Database</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Statistical Plots<span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li id="plotQPS" class=""><a href="/plotGeneral/QPS">QPS statistics</a></li>
                  <li id="plotPercentile50" class=""><a href="/plotGeneral/p50">50<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile90" class=""><a href="/plotGeneral/p90">90<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile95" class=""><a href="/plotGeneral/p95">95<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile99" class=""><a href="/plotGeneral/p99">99<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile99Point9" class=""><a href="/plotGeneral/p99point9">99.9<sup>th</sup> %ile Latency statistics</a></li>
                </ul>
              </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li id="contact_item" class=""><a id="about" onclick="$('#aboutModal').modal()" href="#">Contact</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>

    <!-- Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="aboutModalLabel">Contact Us</h4>
          </div>
          <div class="modal-body">
            <b>For any issues related to this leaderboard, please reach out at: grpc-io@googlegroups.com</b>
          </div>
        </div>
      </div>
    </div>

    <!-- Label containing name of the user -->
    <div class="container">
      <div id="user_label"><h1 align="center">User: <a target="_blank" href="{{ user_link }}">{{ user_name }}</a></h1></div>
    </div>
    <!-- Date range selector -->
    <div class="container">
      <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;">
        <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
        <span></span> <b class="caret"></b>
      </div>
    </div>
    
    <div class="container" style="width: 90%">
      <!-- QPS chart -->
      <div id="chart_div_qps" style="height: 700px;"></div>
      <!-- QPS Per Core chart -->
      <div id="chart_div_qps_per_core" style="height: 700px;"></div>
      <!-- Latency chart -->
      <div id="chart_div_percentile_latencies" style="height: 700px;"></div>
      <!-- Server Times chart -->
      <div id="chart_div_server_times" style="height: 700px;"></div>
      <!-- Client Times chart -->
      <div id="chart_div_client_times" style="height: 700px;"></div>
    </div>
    <!-- Javascript functionality for charts and date range selector -->
    <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChartsOnLoad);

      //Called on loading of chart
      function drawChartsOnLoad() {
        drawCharts(moment().subtract(1000, 'years'), moment());
      }

      //Function for rendering the chart
      function drawCharts(start, end) {
        var qpsArgs = [[{label: 'Time'}, {type: 'number', label:'QPS'}]];
        var qpsPerCoreArgs = [[{label: 'Time'}, {type: 'number', label:'QPS Per Core'}]];
        var latArgs = [[{label: 'Time'}, {type: 'number', label:'50th Percentile Latency'}, {type: 'number', label:'90th Percentile Latency'}, {type: 'number', label:'95th Percentile Latency'}, {type: 'number', label:'99th Percentile Latency'}, {type: 'number', label:'99.9th Percentile Latency'}]];
        var serverTimesArgs = [[{label: 'Time'}, {type: 'number', label:'Server System Time'}, {type: 'number', label:'Server User Time'}]];
        var clientTimesArgs = [[{label: 'Time'}, {type: 'number', label:'Client System Time'}, {type: 'number', label:'Client User Time'}]];

        {% if userdata %}
          {% for item in userdata.qpsData %}
            var metricDate = new Date({{ item.0.year }}, {{ item.0.month }}-1, {{ item.0.day }}, {{ item.0.hour }}, {{ item.0.min }}, {{ item.0.sec }}, 0);
            if(start <= metricDate && end >= metricDate) {
              qpsArgs.push([metricDate, {{ item.1 }}]);
            }
          {% endfor %}

          {% for item in userdata.qpsPerCoreData %}
            var metricDate = new Date({{ item.0.year }}, {{ item.0.month }}-1, {{ item.0.day }}, {{ item.0.hour }}, {{ item.0.min }}, {{ item.0.sec }}, 0);
            if(start <= metricDate && end >= metricDate) {
              qpsPerCoreArgs.push([metricDate, {{ item.1 }}]);
            }
          {% endfor %}

          {% for item in userdata.latData %}
            var metricDate = new Date({{ item.0.year }}, {{ item.0.month }}-1, {{ item.0.day }}, {{ item.0.hour }}, {{ item.0.min }}, {{ item.0.sec }}, 0);
            if(start <= metricDate && end >= metricDate) {
              latArgs.push([metricDate, {{ item.1.perc_lat_50 }}, {{ item.1.perc_lat_90 }}, {{ item.1.perc_lat_95 }}, {{ item.1.perc_lat_99 }}, {{ item.1.perc_lat_99_point_9 }}]);
            }
          {% endfor %}

          {% for item in userdata.timesData %}
            var metricDate = new Date({{ item.0.year }}, {{ item.0.month }}-1, {{ item.0.day }}, {{ item.0.hour }}, {{ item.0.min }}, {{ item.0.sec }}, 0);
            if(start <= metricDate && end >= metricDate) {
              serverTimesArgs.push([metricDate, {{ item.1.server_system_time }}/100.0, {{ item.1.server_user_time }}/100.0]);
              clientTimesArgs.push([metricDate, {{ item.1.client_system_time }}/100.0, {{ item.1.client_user_time }}/100.0]);
            }
          {% endfor %}
        {% endif %}

        //Data for the QPS chart
        var qpsData = google.visualization.arrayToDataTable(
          qpsArgs
        );
        //Data for QPS per core chart
        var qpsPerCoreData = google.visualization.arrayToDataTable(
          qpsPerCoreArgs
        );
        //Data for the latencies chart
        var latData = google.visualization.arrayToDataTable(
          latArgs
        );
        //Data for server times chart
        var serverTimesData = google.visualization.arrayToDataTable(
          serverTimesArgs
        );
        //Data for client times chart
        var clientTimesData = google.visualization.arrayToDataTable(
          clientTimesArgs
        );
        //Options for chart
        var baseOptions = {
          pointSize: 7,
          titleTextStyle: {
              fontSize: 30,
            },
          legend: { position: 'none' },
          curveType: 'function',
          hAxis: {
            title: 'Time',
            titleTextStyle: {
              fontSize: 25,
            },
          },
          vAxis: {
            titleTextStyle: {
              fontSize: 25,
            },
          },
          explorer: { 
            axis:'horizontal',
            maxZoomIn:'0.01',
            maxZoomOut:'10',
          },
        };

        var qpsOptions = jQuery.extend(true, {}, baseOptions);
        qpsOptions.title = 'Queries Per Second';
        qpsOptions.vAxis.title = 'Queries Per Second';

        var qpsPerCoreOptions = jQuery.extend(true, {}, baseOptions);
        qpsPerCoreOptions.title = 'QPS Per Core';
        qpsPerCoreOptions.vAxis.title = 'QPS Per Core';

        var latOptions = jQuery.extend(true, {}, baseOptions);
        latOptions.title = 'Percentile Latencies';
        latOptions.legend.position = 'right';
        latOptions.vAxis.title = 'Percentile Latencies (in \u03BCs)';

        var timesOptions = jQuery.extend(true, {}, baseOptions);
        timesOptions.legend.position = 'right';
        timesOptions.vAxis.title = 'Percentage Time';
        timesOptions.vAxis.format = '0.0%';

        var serverTimesOptions = jQuery.extend(true, {}, timesOptions);
        var clientTimesOptions = jQuery.extend(true, {}, timesOptions);
        serverTimesOptions.title = 'Server Times';
        clientTimesOptions.title = 'Client Times';

        var formatter = new google.visualization.NumberFormat({pattern: '0.0%'});
        formatter.format(serverTimesData, 1);
        formatter.format(serverTimesData, 2);
        formatter.format(clientTimesData, 1);
        formatter.format(clientTimesData, 2);

        //Draw QPS chart
        var chart = new google.visualization.LineChart(document.getElementById('chart_div_qps'));
        chart.draw(qpsData, qpsOptions);

        //Draw QPS per core chart
        chart = new google.visualization.LineChart(document.getElementById('chart_div_qps_per_core'));
        chart.draw(qpsPerCoreData, qpsPerCoreOptions);

        //Draw latencies chart
        chart = new google.visualization.LineChart(document.getElementById('chart_div_percentile_latencies'));
        chart.draw(latData, latOptions);

        //Draw server times chart
        chart = new google.visualization.LineChart(document.getElementById('chart_div_server_times'));
        chart.draw(serverTimesData, serverTimesOptions);

        //Draw client times chart
        chart = new google.visualization.LineChart(document.getElementById('chart_div_client_times'));
        chart.draw(clientTimesData, clientTimesOptions);
        
        //Update date range field
        $('#reportrange span').html(moment(start).format('MM/DD/YYYY, HH:mm:ss') + ' - ' + moment(end).format('MM/DD/YYYY, HH:mm:ss'));
      }

      //Date range picker functionality
      $('#reportrange').daterangepicker({
        format: 'MM/DD/YYYY, HH:mm:ss',
        startDate: moment().subtract(1000, 'years'),
        endDate: moment(),
        showDropdowns: true,
        timePicker: true,
        timePickerIncrement: 1,
        timePicker12Hour: false,
        timePickerSeconds: true,
        ranges: {
          'Today': [moment().startOf('day'), moment()],
          'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
          'Last 7 Days': [moment().subtract(6, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'This Month': [moment().startOf('month'), moment().endOf('month')],
          'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
          'All Time': [moment().subtract(29, 'days'), moment()]
        },
        opens: 'left',
        drops: 'down',
        buttonClasses: ['btn', 'btn-sm'],
        applyClass: 'btn-primary',
        cancelClass: 'btn-default',
        separator: ' to ',
      }, function(start, end, label) {
        drawCharts(start, end);
      });
    </script>
  </body>
</html>