{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      body { 
        padding-top: 70px;
      } 
    </style>
    <title>
      Performance Database
    </title>
    <link rel="shortcut icon" type="image/png" href="../static/images/favicon.png">
      <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Performance Database">
    <meta name="keywords" content="Performance Database, GRPC">

    <!-- Bootstrap core CSS -->
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap table CSS -->
    <link href="../static/css/bootstrap-table.min.css">
    <!-- Date Range picker CSS -->
    <link rel="stylesheet" type="text/css" href="../static/css/daterangepicker-bs3.css" />

    <!-- JQuery core javascript  -->
    <script type="text/javascript" src="../static/jQuery/jquery-1.11.3.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script src="../static/js/bootstrap.min.js"></script>
    <!-- Bootstrap table javascript -->
    <script src="../static/js/bootstrap-table.min.js"></script>
    <!-- Moment Javascript -->
    <script type="text/javascript" src="../static/js/moment.min.js"></script>
    <!-- Date Range picker Javascript -->
    <script type="text/javascript" src="../static/js/daterangepicker.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
          <div class="navbar-header">
            <button id="toggle_button" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>

          <div class="collapse navbar-collapse" id="navbar-collapse">
            <ul class="nav navbar-nav navbar-left">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Statistical Plots<span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li id="plotQPS" class=""><a href="/plotGeneral/QPS">QPS statistics</a></li>
                  <li id="plotQPSPerCore" class=""><a href="/plotGeneral/qpsPerCore">QPS Per Core statistics</a></li>
                  <li id="plotPercentile50" class=""><a href="/plotGeneral/p50">50<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile90" class=""><a href="/plotGeneral/p90">90<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile95" class=""><a href="/plotGeneral/p95">95<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile99" class=""><a href="/plotGeneral/p99">99<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotPercentile99Point9" class=""><a href="/plotGeneral/p99point9">99.9<sup>th</sup> %ile Latency statistics</a></li>
                  <li id="plotServerSysTime" class=""><a href="/plotGeneral/serverSysTime">Server System Time</a></li>
                  <li id="plotServerUserTime" class=""><a href="/plotGeneral/serverUserTime">Server User Time</a></li>
                  <li id="plotClientSysTime" class=""><a href="/plotGeneral/clientSysTime">Client System Time</a></li>
                  <li id="plotClientUserTime" class=""><a href="/plotGeneral/clientUserTime">Client User Time</a></li>
                </ul>
              </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            <li id="about_item" class=""><a id="about" onclick="$('#aboutModal').modal()" href="#">Contact</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>

    <!-- Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="aboutModalLabel">Contact Us</h4>
          </div>
          <div class="modal-body">
            <b>For any issues related to this leaderboard, please reach out at: grpc-io@googlegroups.com</b>
          </div>
        </div>
      </div>
    </div>

    <div class="container" style="width:99%;">
      <h2 align="center">Performance Database</h2>
      <hr>
      <div id="report-range" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; margin-left:10px">
        <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
        <span></span> <b class="caret"></b>
      </div>
      <div id="metrics">
        <table id="metrics-table"
              class="table table-striped"
              data-toggle="table"
              data-search="true"
              data-pagination="true"
              data-show-columns="true">
          <thead id='metrics-table-head'>
            <tr>
              <th data-field="userid"
                  data-sortable="true"
                  data-align="center"
                  data-switchable="false">User</th>
              <th data-field="timestamp"
                  data-sortable="true"
                  data-align="center"
                  data-switchable="false">Timestamp</th>
              <th data-field="testName"
                  data-sortable="true"
                  data-align="center"
                  data-switchable="false">Test</th>
              <th data-field="QPS"
                  data-sortable="true"
                  data-align="center">Queries Per Second</th>
              <th data-field="QPSPerCore"
                  data-sortable="true"
                  data-align="center">QPS Per Core</th>
              <th data-field="p50"
                  data-sortable="true"
                  data-align="center">50<sup>th</sup> %ile latency (&micros)</th>
              <th data-field="p90"
                  data-sortable="true"
                  data-align="center">90<sup>th</sup> %ile latency (&micros)</th>
              <th data-field="p95"
                  data-sortable="true"
                  data-align="center">95<sup>th</sup> %ile latency (&micros)</th>
              <th data-field="p99"
                  data-sortable="true"
                  data-align="center">99<sup>th</sup> %ile latency (&micros)</th>
              <th data-field="p99point9"
                  data-sortable="true"
                  data-align="center">99.9<sup>th</sup> %ile latency (&micros)</th>
              <th data-field="serverSystemTime"
                  data-sortable="true"
                  data-align="center"
                  data-visible="false">Server System Time %</th>
              <th data-field="serverUserTime"
                  data-sortable="true"
                  data-align="center"
                  data-visible="false">Server User Time %</th>
              <th data-field="clientSystemTime"
                  data-sortable="true"
                  data-align="center"
                  data-visible="false">Client System Time %</th>
              <th data-field="clientUserTime"
                  data-sortable="true"
                  data-align="center"
                  data-visible="false">Client User Time %</th>
            </tr>
          </thead>
          <tbody id="metrics-table-body">
          </tbody>
        </table>
      </div>    
    </div><!-- /.container -->
    <script type="text/javascript">

      addDataToTableInit(moment().subtract(1000,'years'), moment());

      function addCell(tableRow, cellContent) {
        var cell = tableRow.insertCell(-1);
        cell.innerHTML = cellContent;
        cell.style.textAlign = 'center';
      }

      function addDataToTableInit(start, end) {
        oldTableBody = document.getElementById("metrics-table-body");
        oldTableBody.innerHTML = '';

        var startDate = moment();
        var endDate = moment().subtract(1000,'years');

        {% for row in request.session.metricstable %}
          rowDate = new Date({{ row.timestamp.year }}, {{ row.timestamp.month }}-1, {{ row.timestamp.day }}, {{ row.timestamp.hour }}, {{ row.timestamp.min }}, {{ row.timestamp.sec }}, 0);
          
          if(rowDate > start && rowDate < end) {
            var tableRow = oldTableBody.insertRow(-1);
            addCell(tableRow, '<a href="/plotUser/{{ row.id }}">{{ row.name }}</a>');
            addCell(tableRow, '{{ row.timestamp.year }}/{{ row.timestamp.month }}/{{ row.timestamp.day }} {{ row.timestamp.hour }}:{{ row.timestamp.min }}:{{ row.timestamp.sec }}');
            addCell(tableRow, '<a id="config" href="/configs/{{ row.client_config }}%{{ row.server_config }}%{{ row.sys_info }}" target="_blank">{{ row.test_name }}</a>');
            addCell(tableRow, '{{ row.qps }}');
            addCell(tableRow, '{{ row.qps_per_core }}');
            addCell(tableRow, '{{ row.perc_lat_50 }}');
            addCell(tableRow, '{{ row.perc_lat_90 }}');
            addCell(tableRow, '{{ row.perc_lat_95 }}');
            addCell(tableRow, '{{ row.perc_lat_99 }}');
            addCell(tableRow, '{{ row.perc_lat_99_point_9 }}');
            addCell(tableRow, '{{ row.server_system_time }}');
            addCell(tableRow, '{{ row.server_user_time }}');
            addCell(tableRow, '{{ row.client_system_time }}');
            addCell(tableRow, '{{ row.client_user_time }}');
            if(rowDate < startDate) {
              startDate = rowDate;
            }
            if(rowDate > endDate) {
              endDate = rowDate;
            }
          }
        {% endfor %}

        $('#report-range span').html(moment(startDate).format('MM/DD/YYYY, HH:mm:ss') + ' - ' + moment(endDate).format('MM/DD/YYYY, HH:mm:ss'));
      }

      function checkHeadersPresent() {
        var headers = document.getElementById("metrics-table-head");
        var headersHTML = headers.rows[0].innerHTML;
        var splitHeaders = headersHTML.split('<div class="th-inner sortable">');

        var isPresent = [false, false, false, false, false, false, false, false, false, false, false];

        if (typeof String.prototype.startsWith != 'function') {
          String.prototype.startsWith = function (str){
            return this.indexOf(str) === 0;
          };
        }

        for (i=4; i<splitHeaders.length; i+=1) {
          var splitHeader = splitHeaders[i].split('</div>');

          if(splitHeader[0] == 'Queries Per Second') {
            isPresent[0] = true;
          }
          else if(splitHeader[0] == 'QPS Per Core') {
            isPresent[1] = true;
          }
          else if(splitHeader[0].startsWith('50<sup>')) {
            isPresent[2] = true;
          }
          else if(splitHeader[0].startsWith('90<sup>')) {
            isPresent[3] = true;
          }
          else if(splitHeader[0].startsWith('95<sup>')) {
            isPresent[4] = true;
          }
          else if(splitHeader[0].startsWith('99<sup>')) {
            isPresent[5] = true;
          }
          else if(splitHeader[0].startsWith('99.9<sup>')) {
            isPresent[6] = true;
          }
          else if(splitHeader[0] == 'Server System Time %') {
            isPresent[7] = true;
          }
          else if(splitHeader[0] == 'Server User Time %') {
            isPresent[8] = true;
          }
          else if(splitHeader[0] == 'Client System Time %') {
            isPresent[9] = true;
          }
          else if(splitHeader[0] == 'Client User Time %') {
            isPresent[10] = true;
          }
        }

        return isPresent;
      }

      $('#report-range').daterangepicker({
        format: 'MM/DD/YYYY, HH:mm:ss',
        showDropdowns: true,
        timePicker: true,
        timePickerIncrement: 1,
        timePicker12Hour: false,
        timePickerSeconds: true,
        ranges: {
          'Today': [moment().startOf('day'), moment()],
          'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
          'Last 7 Days': [moment().subtract(6, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'This Month': [moment().startOf('month'), moment().endOf('month')],
          'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
          'All Time': [moment().subtract(29, 'days'), moment()]
        },
        opens: 'left',
        drops: 'down',
        buttonClasses: ['btn', 'btn-sm'],
        applyClass: 'btn-primary',
        cancelClass: 'btn-default',
        separator: ' to ',
      }, function(start, end, label) {
        isPresent = checkHeadersPresent();

        oldTableBody = document.getElementById("metrics-table-body");
        oldTableBody.innerHTML = '';

        var startDate = moment();
        var endDate = moment().subtract(1000,'years');

        i = 0;

        {% for row in request.session.metricstable %}
          rowDate = new Date({{ row.timestamp.year }}, {{ row.timestamp.month }}-1, {{ row.timestamp.day }}, {{ row.timestamp.hour }}, {{ row.timestamp.min }}, {{ row.timestamp.sec }}, 0);
          
          if(rowDate > start && rowDate < end) {
            var tableRow = oldTableBody.insertRow(-1);
            tableRow.setAttribute("data-index",i+''); i++;

            addCell(tableRow, '<a href="/plotUser/{{ row.id }}">{{ row.name }}</a>');
            addCell(tableRow, '{{ row.timestamp.year }}/{{ row.timestamp.month }}/{{ row.timestamp.day }} {{ row.timestamp.hour }}:{{ row.timestamp.min }}:{{ row.timestamp.sec }}');
            addCell(tableRow, '<a id="config" href="/configs/{{ row.client_config }}%{{ row.server_config }}%{{ row.sys_info }}" target="_blank">{{ row.test_name }}</a>');
            
            if(isPresent[0]) { addCell(tableRow, '{{ row.qps }}'); }
            if(isPresent[1]) { addCell(tableRow, '{{ row.qps_per_core }}'); }
            if(isPresent[2]) { addCell(tableRow, '{{ row.perc_lat_50 }}'); }
            if(isPresent[3]) { addCell(tableRow, '{{ row.perc_lat_90 }}'); }
            if(isPresent[4]) { addCell(tableRow, '{{ row.perc_lat_95 }}'); }
            if(isPresent[5]) { addCell(tableRow, '{{ row.perc_lat_99 }}'); }
            if(isPresent[6]) { addCell(tableRow, '{{ row.perc_lat_99_point_9 }}'); }
            if(isPresent[7]) { addCell(tableRow, '{{ row.server_system_time }}'); }
            if(isPresent[8]) { addCell(tableRow, '{{ row.server_user_time }}'); }
            if(isPresent[9]) { addCell(tableRow, '{{ row.client_system_time }}'); }
            if(isPresent[10]) { addCell(tableRow, '{{ row.client_user_time }}'); }

            if(rowDate < startDate) {
              startDate = rowDate;
            }
            if(rowDate > endDate) {
              endDate = rowDate;
            }
          }
        {% endfor %}
      });
    </script>
  </body>
</html>
  